# Add this to your Apache virtual host configuration for openmosaics.com

# Enable required modules (add to main Apache config if not already enabled)
# LoadModule proxy_module modules/mod_proxy.so
# LoadModule proxy_http_module modules/mod_proxy_http.so
# LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
# LoadModule rewrite_module modules/mod_rewrite.so

<VirtualHost *:443>
    ServerName openmosaics.com
    
    # Your existing SSL configuration
    SSLEngine on
    SSLCertificateFile /path/to/your/cert.pem
    SSLCertificateKeyFile /path/to/your/private.key
    
    # Regular HTTP proxy for API endpoints
    ProxyPreserveHost On
    ProxyPass /api/ http://localhost:3000/api/
    ProxyPassReverse /api/ http://localhost:3000/api/
    
    # WebSocket proxy configuration for Socket.IO
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/ws/(.*) "ws://localhost:3000/ws/$1" [P,L]
    
    # Regular WebSocket proxy
    ProxyPass /ws/ ws://localhost:3000/ws/
    ProxyPassReverse /ws/ ws://localhost:3000/ws/
    
    # Fallback for non-WebSocket Socket.IO requests (polling)
    ProxyPass /ws/ http://localhost:3000/ws/
    ProxyPassReverse /ws/ http://localhost:3000/ws/
    
    # Main application proxy
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
    
    # WebSocket specific headers
    ProxySet connectiontimeout 5
    ProxySet ttl 60
</VirtualHost>

<VirtualHost *:80>
    ServerName openmosaics.com
    # Redirect HTTP to HTTPS
    Redirect permanent / https://openmosaics.com/
</VirtualHost>
